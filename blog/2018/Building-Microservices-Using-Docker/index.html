<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Building microservices using docker swarm with Oauth2 | Sunil P. Sarolkar </title> <meta name="author" content="Sunil P. Sarolkar"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://spsarolkar.github.io/blog/2018/Building-Microservices-Using-Docker/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Sunil</span> P. Sarolkar </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Building microservices using docker swarm with Oauth2</h1> <p class="post-meta"> Created on September 30, 2018 </p> <p class="post-tags"> <a href="/blog/2018"> <i class="fa-solid fa-calendar fa-sm"></i> 2018 </a>   ·   <a href="/blog/category/docker"> <i class="fa-solid fa-tag fa-sm"></i> docker</a>   <a href="/blog/category/microservices"> <i class="fa-solid fa-tag fa-sm"></i> microservices</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Today we will learn how to build simple multi tier microservice using Oauth2 authorization with Redis session management. Our front end will be build using Spring Boot which will use backend python service for fetching the fortune message to be displayed. The block diagram for the application is as below. All the example code is uploaded to github at <a href="https://github.com/spsarolkar/docker-swarm-example" rel="external nofollow noopener" target="_blank">Github</a></p> <div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph='{"highlight":"#0000ff","nav":true,"resize":true,"toolbar":"zoom layers lightbox","edit":"_blank","xml":"&lt;mxfile userAgent=\"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.119 Safari/537.36\" version=\"9.1.8\" editor=\"www.draw.io\" type=\"google\"&gt;&lt;diagram id=\"2ae52b09-a662-b48f-7fa8-6262e6cde334\" name=\"Page-1\"&gt;zVfbcpswEP0az7QPyXCzcR4TJ007004ydWeSPMpoDZoAokIYnK/vCgSYiy+TS9sXvDparaTdoyN5Yi+i4laQJPjBKYQTy6DFxL6eWJY7t/CrgK0GbA34gtEKMltgyV5Ag4ZGM0Yh7ThKzkPJki7o8TgGT3YwIgTPu25rHnZnTYgPA2DpkXCIPjAqgwqdT40W/wrMD+qZTUP3RKR21kAaEMrzHci+mdgLwbmsrKhYQKhyV+elGvdlT2+zMAGxPGWANZ3PiGub5mrueJTQMx1hQ8JMb3ZizUKMdbVCw1dGDaw5zoFbkFudl9nvjNcdZ2lZtUt0MC+Sou2sozwABjS+xRLEmnhQB8WlVnG7cyE8mH8lauTTMhEs9jFeFZUkScg8IhmPsZUzTLpl3HLu40It445kMiipgL9csJfS8fMwrC5Rsz8rD5iEZaKWa1/nSG10CmQUYstEk6RJxbY1K4A2ATYgJBR7C2Q2ZcfjAjwCKbboogc0nNdHxXR1O2+JZ841FuySrgaJJrvfxG75gIamxIn0sD+AHtMxevwEylIlEas3MgPStKJBKrnAg3lKnfFUJsr0tiGLKQj0OVL6Fc/QkX5fNQDxnn2h0LtMYhTQ+DtQwnG7lBhjhDXCiA8hxGyEEL1sepnYqONQ7h9ieqkUWGU3JFgbr5tIKJh8RNs4n+rWk2o1mQM6kOZe3nBungkPDgucJMIHeYjlw/zvJHg6kt8aExCiomy6yxxLup7hnrPypOw58Y7Vq1u1PT1qV9v7gWbdQLbbC1TlYBAI60O2O26Jckj3L9ju8dF0OncOGlXElmBNTl/HOfcDRGg+JkILfCmoVLxBgK5QB5Dzag0gNkxddEYumJSgNImpz/0WryFlyIDIkmbl9n2IQRAJZQeUzxQhs1hZEYoaSll6jvavoNRJPSgiz8ohS9WXr5UZs6J8ClVbMUi5mDZWJlnIpOpJBPcFicrH1OH5UbsUIf7H+9Lpk94aUcex09uA7yqP8+PyeFQRY1zEoxbBsvHU6ONf1ET3X2qi43Sral28UhOdi14g5zRNPC5b2Gyf7ZV7+9/HvvkD&lt;/diagram&gt;&lt;/mxfile&gt;"}'></div> <script type="text/javascript" src="https://www.draw.io/js/viewer.min.js"></script> <h3 id="user-interface">User Interface</h3> <p>Spring boot comes with lot of convenient defaults that allows to jump start for developing any application. We will make use of spring boot security to configure our Oauth2 filter. We will make use of Google Oauth2 endpoint for authorizing our application. For this we first need to obtain the client key and client secret from Google. Go to <a href="https://start.spring.io/" rel="external nofollow noopener" target="_blank">Spring Initializr</a>. Select Web, security and oauth2 in the dependencies field and click on download button.</p> <h5 id="obtain-oauth2-client-key-and-client-secret-from-google">Obtain Oauth2 client key and client secret from Google</h5> <p>To obtain client key and client secret, Click on <a href="https://console.cloud.google.com" rel="external nofollow noopener" target="_blank">Google console</a>. Click on start new project from dropdown above, fill up the details of your demo project. Open the left side menu and select “API and Services” &gt; “Credentials”. Enter the required details in the form, Please note that for Spring “Authorised redirect URIs” should be “http://<servername>/login" e.g. http://localhost:8080/login. Click on create.</servername></p> <p>Once you generate the keys you are ready to use it in our Spring application.</p> <h5 id="configure-the-spring-application-with-oauth2-client-and-client-secret">Configure the Spring application with Oauth2 client and client secret</h5> <p>Before using the client and client secret we need to enable Oauth2 for Spring application. We will make use of <code class="language-plaintext highlighter-rouge">@EnableOAuth2Sso</code> annotation for this. This annotation allows us to configure OAuth endpoints using simple configuration in <code class="language-plaintext highlighter-rouge">application.yml</code> file.</p> <p>application.yml</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
  <span class="na">oauth2</span><span class="pi">:</span>
    <span class="na">client</span><span class="pi">:</span>
      <span class="na">clientId</span><span class="pi">:</span> <span class="s">434972283788-j1n2hihmbr8hvf0a9hfa65dnvh15b4qh.apps.googleusercontent.com</span>
      <span class="na">clientSecret</span><span class="pi">:</span> <span class="s">gHPRImLetr6u-nT5lZTqeQm3</span>
      <span class="na">accessTokenUri</span><span class="pi">:</span> <span class="s">https://www.googleapis.com/oauth2/v4/token</span>
      <span class="na">userAuthorizationUri</span><span class="pi">:</span> <span class="s">https://accounts.google.com/o/oauth2/v2/auth</span>
      <span class="na">tokenName</span><span class="pi">:</span> <span class="s">access_token</span>
      <span class="na">authenticationScheme</span><span class="pi">:</span> <span class="s">query</span>
      <span class="na">clientAuthenticationScheme</span><span class="pi">:</span> <span class="s">form</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">https://www.googleapis.com/auth/userinfo.profile</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">userInfoUri</span><span class="pi">:</span> <span class="s">https://www.googleapis.com/oauth2/v2/userinfo</span>
<span class="na">app</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">cowsay</span><span class="pi">:</span>

<span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">org.springframework.security</span><span class="pi">:</span> <span class="s">DEBUG</span>
</code></pre></div></div> <p>Spring boot application configuration</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableOAuth2Sso</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FortuneTellerUiApplication</span>  <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">http</span><span class="o">.</span><span class="na">antMatcher</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span><span class="s">"/login**"</span><span class="o">,</span><span class="s">"/webjars/**"</span><span class="o">,</span><span class="s">"/error/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">().</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">csrfTokenRepository</span><span class="o">(</span><span class="nc">CookieCsrfTokenRepository</span><span class="o">.</span><span class="na">withHttpOnlyFalse</span><span class="o">()).</span><span class="na">and</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">FortuneTellerUiApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>For calling the backend service we will make use of simple RestTemplate.</p> <h3 id="cowsay-rest-service">Cowsay rest service</h3> <p>We will develop our backend in python with <a href="https://www.djangoproject.com/" rel="external nofollow noopener" target="_blank">Django</a>. You need to have python 3.5 with pip installed on your machine to proceed further.</p> <h4 id="install-and-configure-django">Install and configure Django</h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## Initialize project directory</span>
<span class="nb">mkdir </span>cowsay-service

<span class="c">## Create python virtual environment</span>
virtualenv <span class="nb">env
source env</span>/bin/activate

<span class="c"># Install Django and Django REST framework into the virtualenv</span>
pip <span class="nb">install </span>django
pip <span class="nb">install </span>djangorestframework

<span class="c"># Set up a new project with a single application</span>
django-admin.py startproject cowsay <span class="nb">.</span>  <span class="c"># Note the trailing '.' character</span>
<span class="nb">cd </span>cowsay
django-admin.py startapp cowsayRest
<span class="nb">cd</span> ..

</code></pre></div></div> <p>Create model for Message</p> <p>Update <code class="language-plaintext highlighter-rouge">cowsayRest/models.py</code> with our Message model</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">serverName</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">serverName</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="n">self</span><span class="p">.</span><span class="n">serverName</span> <span class="o">=</span> <span class="n">serverName</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">created</span><span class="sh">'</span><span class="p">,)</span>
</code></pre></div></div> <p>We need model to be serialzed to Json object so we need to define which fields to be included in the serialization and how the individual fields to be serialized.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MessageSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="nc">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">serverName</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="nc">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</code></pre></div></div> <p>We will define view for our application which will just produce fortune and cowsay command to generate the message text, and this message text will be serialized using serializer defined above.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fortune</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">fortune</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">((</span><span class="sh">'</span><span class="s">fortune</span><span class="sh">'</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">check_output</span><span class="p">((</span><span class="sh">'</span><span class="s">cowsay</span><span class="sh">'</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">fortune</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">fortune</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nc">MessageSerializer</span><span class="p">(</span><span class="nc">Message</span><span class="p">(</span><span class="n">message</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">),</span><span class="n">serverName</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">gethostname</span><span class="p">()))</span>
    <span class="k">return</span> <span class="nc">JsonResponse</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <p>We are all set only thing remaining is mapping the url to point to view we defined. initialize <code class="language-plaintext highlighter-rouge">cowsayRest/urls.py</code> with the url mapping as below</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nf">url</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">^fortune/$</span><span class="sh">'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">fortune</span><span class="p">),</span>
    <span class="nf">url</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">^</span><span class="sh">'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">fortune</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div> <p>As you have noticed we have mapped <code class="language-plaintext highlighter-rouge">/fortune</code> and <code class="language-plaintext highlighter-rouge">/*</code> url to same view fortune. I have done this because there is a possibility that the load balancer check the health of the application by sending the request at the root of the application. Otherwise you can skip the second mapping and only keep the mapping for <code class="language-plaintext highlighter-rouge">fortune/</code></p> <p>Last but not the least we need to enable Django rest app in <code class="language-plaintext highlighter-rouge">cowsay/settings.py</code></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">'</span><span class="s">rest_framework</span><span class="sh">'</span><span class="p">,</span>
 <span class="bp">...</span>
</code></pre></div></div> <h4 id="building-the-docker-containers">Building the docker containers</h4> <p>As we are making of Spring Boot, we will make use of plugin offered by Spring Framework to generate the docker image, so include below plugin in pom.xml</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>com.spotify<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>dockerfile-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>1.4.4<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;configuration&gt;</span>
					<span class="nt">&lt;repository&gt;</span>${docker.image.prefix}/${project.artifactId}<span class="nt">&lt;/repository&gt;</span>
					<span class="nt">&lt;buildArgs&gt;</span>
						<span class="nt">&lt;JAR_FILE&gt;</span>target/${project.build.finalName}.jar<span class="nt">&lt;/JAR_FILE&gt;</span>
						<span class="nt">&lt;tag&gt;</span>${project.artifactId}-${project.version}<span class="nt">&lt;/tag&gt;</span>
					<span class="nt">&lt;/buildArgs&gt;</span>
				<span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div> <p>Create a Dockerfile under UI project</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM openjdk:8-jdk-alpine
VOLUME /tmp
ARG JAR_FILE
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"]
</code></pre></div></div> <p>For Cowsay rest service we will make use of Docker file as below</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM python:3
COPY . /usr/src/app
WORKDIR /usr/src/app
RUN pip install -r requirements.txt
EXPOSE 8000
USER root
RUN apt-get update &amp;&amp; apt-get -y --fix-missing upgrade &amp;&amp; apt-get install -y --fix-missing fortune cowsay
CMD ["./start.sh"]
</code></pre></div></div> <p>As you might have noted that we are using start.sh to initialize our Django app and start the development server</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=/usr/games:$PATH
python manage.py migrate
python manage.py runserver 0.0.0.0:8000 &gt;&gt; log 2&gt;&amp;1
</code></pre></div></div> <p>In the abo file we are initializing the PATH environment variable to include fortune and cowsay programs from <code class="language-plaintext highlighter-rouge">/usr/games/</code> directory.</p> <p>We will trigger the build for above two docker images using <code class="language-plaintext highlighter-rouge">build.sh</code></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="nb">cd </span>fortune-teller-ui<span class="p">;</span> ./mvnw clean package <span class="o">&amp;&amp;</span> ./mvnw <span class="nb">install </span>dockerfile:build<span class="o">)</span>
<span class="o">(</span><span class="nb">cd </span>cowsay-service/cowsay<span class="p">;</span> docker build <span class="nt">-t</span> spsarolkar/cowsay .<span class="o">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">(cd fortune-teller-ui; ./mvnw clean package &amp;&amp; ./mvnw install dockerfile:build)</code> – This comand builds the User Interface executable jar file using spring boot maven plugin and then spring docker plugin generates the docker image.</p> <p><code class="language-plaintext highlighter-rouge">(cd cowsay-service/cowsay; docker build -t spsarolkar/cowsay .)</code> –&gt; This is a used for generating docker image for Cowsay Rest service</p> <h4 id="docker-swarm-configuration">Docker swarm configuration</h4> <p>Once we have both the images build we will move on the creating the docker Swarm configuration. create new file <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> under root of the project.</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.2"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">sessions</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis:4</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">6379:6379</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">web</span><span class="pi">:</span>
        <span class="na">aliases</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">redis</span>

  <span class="na">cowsay-service</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">spsarolkar/cowsay</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="m">8000</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">SERVICE_PORTS=8000</span>
    <span class="na">deploy</span><span class="pi">:</span>
      <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">restart_policy</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">on-failure</span>
        <span class="na">max_attempts</span><span class="pi">:</span> <span class="m">3</span>
        <span class="na">window</span><span class="pi">:</span> <span class="s">120s</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">web</span><span class="pi">:</span>
        <span class="na">aliases</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">cowsay-cluster</span>

  <span class="na">cowsay-proxy</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">dockercloud/haproxy:1.6.7</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">cowsay-service</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">BALANCE=leastconn</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8000:80"</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">web</span><span class="pi">:</span>
        <span class="na">aliases</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">cowsay</span>
    <span class="na">deploy</span><span class="pi">:</span>
      <span class="na">placement</span><span class="pi">:</span>
        <span class="na">constraints</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">node.role == manager</span><span class="pi">]</span>

  <span class="na">cowsay-ui</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">spsarolkar/cowsay-ui</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:8080"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">COWSAY_SERVER_NAME=cowsay</span>
      <span class="pi">-</span> <span class="s">COWSAY_SERVER_PORT=80</span>
      <span class="pi">-</span> <span class="s">REDIS_SERVER_NAME=redis</span>
      <span class="pi">-</span> <span class="s">REDIS_SERVER_PORT=6379</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">redis</span>
      <span class="pi">-</span> <span class="s">cowsay</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">web</span><span class="pi">:</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
</code></pre></div></div> <p>Along with the images we built, there are two more images configured. Please find the details below.</p> <h5 id="redis4">redis:4</h5> <p>This image is used for redis database for session management. Currently we only configured single instance of UI but we can scale more just by adding more instances without worrying about sticky sessions.</p> <h5 id="dockercloudhaproxy167">dockercloud/haproxy:1.6.7</h5> <p>This image is a load balancer for backend Cowsay Rest service.</p> <p>We are all set to start our service using below command</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack deploy <span class="nt">--compose-file</span><span class="o">=</span>docker-compose.yml prod
</code></pre></div></div> <p>Once all images deployed you will see out UI once you visit the browser http://127.0.0.1:8080/</p> <p><img src="/images/1_docker_swarm_example_landing_page.png" alt="landing-page"></p> <p>Click on “Login with Google” button and you will be directed to Google OAuth authentication page. Once you login to your google account you will be redirected to home page and the <code class="language-plaintext highlighter-rouge">fortune</code> message will be displayed with <code class="language-plaintext highlighter-rouge">cowsay</code> decoration. Also notice the servername displayed in red to confirm that any subsequent requests are responded using different backend server handled by <code class="language-plaintext highlighter-rouge">haproxy</code> for load balancing purpose.</p> <p><img src="/images/2_Rest_Server_Response.png" alt="cowsay-message-1"></p> <p><img src="/images/3_Rest_Server_Response.png" alt="cowsay-message-2"></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/Configuring-Redis-High-Availability-Sentinel-Configuration/">Redis High Availability Solution using Redis Sentinel and docker</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/Plybar-does-not-support-bridge-interface/">Polybar does not support the bridge interface for network tracking</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/Google-cloud-kubernetes-example/">Google cloud kubernetes example</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Sunil P. Sarolkar. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>